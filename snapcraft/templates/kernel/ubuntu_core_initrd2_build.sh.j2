# Ubuntu initrd snapcraft build script
# Generated by snapcraft ubuntu-initrd plugin.
# ----
# Build on:  {{ craft_arch_build_on }}
# Build for: {{ craft_arch_build_for }}
# Snapcraft version: {{ snap_version }}
# Snap data: {{ snap_data_path }}
# Snap context: {{ snap_context }}
# ----
# TODO(esh) remove; handy for debug, --debug and --shell has a different env
# Ignore SC1091 "Not following: x/y/z.sh was not specified as input"
shellcheck -e SC1091 "$0"
env

echo "Generating initrd with ko modules for kernel release: ${KERNEL_RELEASE}"
{% if initrd_ko_use_workaround %}
initrd_configured_modules = "$(cat ${initramfs_ko_modules_conf})"
{% else %}
initrd_configured_modules = "${initrd_configured_kernel_modules}"
{% endif %}

echo "Installing ko modules to initrd..."
# shellcheck disable=SC2034 #SC2034 does not apply as install_modules not be always used
install_modules=""
echo "Gathering module dependencies..."
uc_initrd_feature_kernel_modules=${{UC_INITRD_ROOT}}/usr/lib/ubuntu-core-initramfs/kernel-modules
mkdir -p "${{uc_initrd_feature_kernel_modules}}"
initramfs_ko_modules_conf=${{UC_INITRD_ROOT}}/usr/lib/ubuntu-core-initramfs/extra-modules.conf
rm -rf "${{initramfs_ko_modules_conf}}"
for m in ${{initrd_installed_kernel_modules}} ${{initrd_configured_kernel_modules}}
do
echo "${{m}}" >> "${{initramfs_ko_modules_conf}}"
done
[ -e "${{initramfs_ko_modules_conf}}" ] && sort -fu "${{initramfs_ko_modules_conf}}" -o "${{initramfs_ko_modules_conf}}"

echo "Configuring ubuntu-core-initramfs.conf with supported modules"
echo "If module does not exist, do not include it"
initramfs_conf_dir=${{uc_initrd_feature_kernel_modules}}/usr/lib/modules-load.d
mkdir -p "${{initramfs_conf_dir}}"
initramfs_conf=${{initramfs_conf_dir}}/ubuntu-core-initramfs.conf
echo "# configured modules" > "${{initramfs_conf}}"
# shellcheck disable=SC2013 #SC2013 does not apply as array could be env, or file content
for m in {initrd_configured_modules}
do
if [ -n "$(modprobe -n -q --show-depends -d "${{CRAFT_STAGE}}" -S "${{KERNEL_RELEASE}}" "${{m}}")" ] ; then
echo "${{m}}" >> "${{initramfs_conf}}"
fi
done

        cmd_prepare_initrd_overlay_feature,
        cmd_prepare_initrd_overlay_firmware,
        cmd_prepare_initrd_overlay,
        cmd_prepare_initrd_addons,
        cmd_prepare_snap_bootstrap_feature,
        'echo "Create new initrd..."',
        cmd_create_initrd_rm_existing,
        cmd_create_initrd_update_compression,
        cmd_create_initrd_workaround,
        cmd_create_initrd_install_extra_modules,
        cmd_create_initrd_build_initrd,
        cmd_create_initrd_install_initrd,
        cmd_create_initrd_build_efi_setup_keys,
        cmd_create_initrd_build_efi,
